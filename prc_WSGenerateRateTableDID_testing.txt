SET @p_jobId = 461;
SET @p_RateGeneratorId = 6;
SET @p_RateTableId = -1 ;
SET @p_rateTableName = '_TST_231219';
SET @p_EffectiveDate = '2019-12-23';
SET @p_delete_exiting_rate = 1;
SET @p_EffectiveRate = 'now';
SET @p_ModifiedBy		= '_TST_231219';

call prc_WSGenerateRateTableDID_TEST( @p_jobId , @p_RateGeneratorId , @p_RateTableId , @p_rateTableName , @p_EffectiveDate , @p_delete_exiting_rate ,  @p_EffectiveRate ,  @p_ModifiedBy );
-- select sum(Total) from tmp_table_output_1 GROUP BY VendorConnectionID, Code, AccessType ,CountryID ,City ,Tariff ;


SET @p_jobId = 461;
SET @p_RateGeneratorId = 5;
SET @p_RateTableId = -1 ;
SET @p_rateTableName = '_TST_201219';
SET @p_EffectiveDate = '2019-12-20';
SET @p_delete_exiting_rate = 1;
SET @p_EffectiveRate = 'now';
SET @p_ModifiedBy		= '_TST_201219';

-- call prc_WSGenerateRateTableDID( @p_jobId , @p_RateGeneratorId , @p_RateTableId , @p_rateTableName , @p_EffectiveDate , @p_delete_exiting_rate ,  @p_EffectiveRate ,  @p_ModifiedBy );
-- CALL prc_WSGenerateRateTableDID(614,5,202,'','2019-12-19',1,'now','Onno Westra')  





+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| RateTableID | TimezonesID | TimezoneTitle | CodeDeckId | CountryID | AccessType          | CountryPrefix | City | Tariff     | Code  | OriginationCode | VendorConnectionID | VendorID | EndDate | OneOffCost | MonthlyCost | CostPerCall | CostPerMinute | SurchargePerCall | SurchargePerMinute | OutpaymentPerCall | OutpaymentPerMinute | Surcharges | Chargeback | CollectionCostAmount | CollectionCostPercentage | RegistrationCostPerNumber | OneOffCostCurrency | MonthlyCostCurrency | CostPerCallCurrency | CostPerMinuteCurrency | SurchargePerCallCurrency | SurchargePerMinuteCurrency | OutpaymentPerCallCurrency | OutpaymentPerMinuteCurrency | SurchargesCurrency | ChargebackCurrency | CollectionCostAmountCurrency | RegistrationCostPerNumberCurrency | new_OneOffCost | new_MonthlyCost | new_CostPerCall | new_CostPerMinute | new_SurchargePerCall | new_SurchargePerMinute | new_OutpaymentPerCall | new_OutpaymentPerMinute | new_Surcharges | new_Chargeback | new_CollectionCostAmount | new_CollectionCostPercentage | new_RegistrationCostPerNumber | MarginRuleApplied_OneOffCost | MarginRuleApplied_MonthlyCost | MarginRuleApplied_CostPerCall | MarginRuleApplied_CostPerMinute | MarginRuleApplied_SurchargePerCall | MarginRuleApplied_SurchargePerMinute | MarginRuleApplied_OutpaymentPerCall | MarginRuleApplied_OutpaymentPerMinute | MarginRuleApplied_Surcharges | MarginRuleApplied_Chargeback | MarginRuleApplied_CollectionCostAmount | MarginRuleApplied_CollectionCostPercentage | MarginRuleApplied_RegistrationCostPerNumber |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 1           | Default       | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | FIX             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.29000000  | 0.00000000    | 0.00000000       | 0.00000000         | 1.65289300        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 10          | Off Peak      | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | FIX             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.00000000  | 0.02340000    | 0.00000000       | 0.00000000         | 0.00000000        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 13          | Peak          | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | FIX             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.00000000  | 0.03560000    | 0.00000000       | 0.00000000         | 0.00000000        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 1           | Default       | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | MOB             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.42000000  | 0.16000000    | 0.00000000       | 0.00000000         | 1.65289300        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 1           | Default       | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | PAY             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.29000000  | 0.00000000    | 0.00000000       | 0.00000000         | 1.65289300        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 10          | Off Peak      | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | PAY             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.00000000  | 0.02340000    | 0.00000000       | 0.00000000         | 0.00000000        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+
| 141         | 13          | Peak          | 4          | 67        | Premium Rate Number | 32            |      | 2 per call | 32905 | PAY             | 44                 | 26       |         | 0.00000000 | 0.00000000  | 0.00000000  | 0.03560000    | 0.00000000       | 0.00000000         | 0.00000000        | 0.00000000          | 0.00000000 | 0.00000000 | 0.00000000           | 0.00000000               | 0.00000000                | 9                  | 9                   | 9                   | 9                     | 9                        | 9                          | 9                         | 9                           | 9                  | 9                  | 9                            | 9                                 |                |                 |                 |                   |                      |                        |                       |                         |                |                |                          |                              |                               |                              |                               |                               |                                 |                                    |                                      |                                     |                                       |                              |                              |                                        |                                            |                                             |
+-------------+-------------+---------------+------------+-----------+---------------------+---------------+------+------------+-------+-----------------+--------------------+----------+---------+------------+-------------+-------------+---------------+------------------+--------------------+-------------------+---------------------+------------+------------+----------------------+--------------------------+---------------------------+--------------------+---------------------+---------------------+-----------------------+--------------------------+----------------------------+---------------------------+-----------------------------+--------------------+--------------------+------------------------------+-----------------------------------+----------------+-----------------+-----------------+-------------------+----------------------+------------------------+-----------------------+-------------------------+----------------+----------------+--------------------------+------------------------------+-------------------------------+------------------------------+-------------------------------+-------------------------------+---------------------------------+------------------------------------+--------------------------------------+-------------------------------------+---------------------------------------+------------------------------+------------------------------+----------------------------------------+--------------------------------------------+---------------------------------------------+



/*	DROP TEMPORARY TABLE IF EXISTS tmp_dup_SelectedVendortblRateTableDIDRate;
		CREATE TEMPORARY TABLE tmp_dup_SelectedVendortblRateTableDIDRate LIKE tmp_SelectedVendortblRateTableDIDRate;
		INSERT INTO tmp_dup_SelectedVendortblRateTableDIDRate SELECT * FROM tmp_SelectedVendortblRateTableDIDRate;


		-- ####################################
		-- margin component  starts
		-- ####################################

		SET @ALL_TIMEZONES_EXCEPT_DEFAULT = ( select group_concat(distinct TimezonesID) from  tmp_SelectedVendortblRateTableDIDRate WHERE TimezonesID != @v_default_TimezonesID );

	 	SET @v_pointer_ = 1;
		SET @v_rowCount_ = ( SELECT COUNT(*) FROM tmp_Raterules_ );

-- select @v_rateRuleId_ 
			SET @v_rateRuleId_ = ( SELECT rateruleid FROM tmp_Raterules_ rr WHERE rr.RowNo = @v_pointer_ );
*/
-- select @ALL_TIMEZONES_EXCEPT_DEFAULT;
select * from tmp_SelectedVendortblRateTableDIDRate;
-- select * from tmp_Raterules_ where RowNo = 9 ; 41 , 40, 236
-- update
							select distinct /*drt.CostPerMinute, rr.Component, */ rt.*
							from  tmp_SelectedVendortblRateTableDIDRate rt
							inner join tmp_Raterules_ rr on rr.RowNo  = 9 -- @v_pointer_
							and ( fn_IsEmpty(rr.TimezonesID) OR rr.TimezonesID  = rt.TimezonesID )
							and (  fn_IsEmpty(rr.Origination) OR rr.Origination = rt.OriginationCode )
							AND (  fn_IsEmpty(rr.CountryID) OR rt.CountryID = 	rr.CountryID )
							AND (  fn_IsEmpty(rr.AccessType) OR rt.AccessType = 	rr.AccessType )
	 						AND (  fn_IsEmpty(rr.Prefix)  OR rt.Code = 	concat(rt.CountryPrefix ,TRIM(LEADING '0' FROM rr.Prefix)) )
							AND (  fn_IsEmpty(rr.City) OR rt.City = 	rr.City )
							AND (  fn_IsEmpty(rr.Tariff) OR rt.Tariff = 	rr.Tariff )
							INNER JOIN tmp_dup_SelectedVendortblRateTableDIDRate drt ON 
								 (  rt.OriginationCode 	= drt.OriginationCode )
							AND (  rt.CountryID 	= drt.CountryID )
							AND (  rt.AccessType 	= drt.AccessType )
	 						AND (  rt.Code 			= drt.Code )
							AND (  rt.City			= drt.City )
							AND (  rt.Tariff 		= drt.Tariff )
							AND
							(
									( 
										rr.TimezonesID IN ( @ALL_TIMEZONES_EXCEPT_DEFAULT ) 
									)
									OR
									(
										( (fn_IsEmpty(rr.TimezonesID)  OR (rr.TimezonesID = rt.TimezonesID AND rt.TimezonesID = @v_default_TimezonesID)) )


										AND 
										(
											(rr.Component = 'OneOffCost' AND ( !fn_IsEmpty(rt.OneOffCost) )) OR
											(rr.Component = 'MonthlyCost' AND ( !fn_IsEmpty(rt.MonthlyCost) )) OR
											(rr.Component = 'CostPerCall' AND ( !fn_IsEmpty(rt.CostPerCall) )) OR
											(rr.Component = 'CostPerMinute' AND ( !fn_IsEmpty(rt.CostPerMinute) )) OR
											(rr.Component = 'SurchargePerCall' AND ( !fn_IsEmpty(rt.SurchargePerCall) )) OR
											(rr.Component = 'SurchargePerMinute' AND ( !fn_IsEmpty(rt.SurchargePerMinute) )) OR
											(rr.Component = 'OutpaymentPerCall' AND ( !fn_IsEmpty(rt.OutpaymentPerCall) )) OR
											(rr.Component = 'OutpaymentPerMinute' AND ( !fn_IsEmpty(rt.OutpaymentPerMinute) )) OR
											(rr.Component = 'Surcharges' AND ( !fn_IsEmpty(rt.Surcharges) )) OR
											(rr.Component = 'Chargeback' AND ( !fn_IsEmpty(rt.Chargeback) )) OR
											(rr.Component = 'CollectionCostAmount' AND ( !fn_IsEmpty(rt.CollectionCostAmount) )) OR
											(rr.Component = 'CollectionCostPercentage' AND ( !fn_IsEmpty(rt.CollectionCostPercentage) )) OR
											(rr.Component = 'RegistrationCostPerNumber' AND ( !fn_IsEmpty(rt.RegistrationCostPerNumber) ))  

										)

									)  
									OR 
									(
										( rr.TimezonesID = rt.TimezonesID AND rt.TimezonesID = @v_default_TimezonesID  AND drt.TimezonesID IN ( @ALL_TIMEZONES_EXCEPT_DEFAULT ) )   
										AND
										(
											(rr.Component = 'OneOffCost' AND ( fn_IsEmpty(drt.OneOffCost) )) OR
											(rr.Component = 'MonthlyCost' AND ( fn_IsEmpty(drt.MonthlyCost) )) OR
											(rr.Component = 'CostPerCall' AND ( fn_IsEmpty(drt.CostPerCall) )) OR
											(rr.Component = 'CostPerMinute' AND ( fn_IsEmpty(drt.CostPerMinute) )) OR
											(rr.Component = 'SurchargePerCall' AND ( fn_IsEmpty(drt.SurchargePerCall) )) OR
											(rr.Component = 'SurchargePerMinute' AND ( fn_IsEmpty(drt.SurchargePerMinute) )) OR
											(rr.Component = 'OutpaymentPerCall' AND ( fn_IsEmpty(drt.OutpaymentPerCall) )) OR
											(rr.Component = 'OutpaymentPerMinute' AND ( fn_IsEmpty(drt.OutpaymentPerMinute) )) OR
											(rr.Component = 'Surcharges' AND ( fn_IsEmpty(drt.Surcharges) )) OR
											(rr.Component = 'Chargeback' AND ( fn_IsEmpty(drt.Chargeback) )) OR
											(rr.Component = 'CollectionCostAmount' AND ( fn_IsEmpty(drt.CollectionCostAmount) )) OR
											(rr.Component = 'CollectionCostPercentage' AND ( fn_IsEmpty(drt.CollectionCostPercentage) )) OR
											(rr.Component = 'RegistrationCostPerNumber' AND ( fn_IsEmpty(drt.RegistrationCostPerNumber) ))  
										)
									)
							 
							)

